name: Daily Kalibrr Export and CV Link Update

on:
  schedule:
    # Run every night at 00:00 UTC (07:00 WIB)
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write

jobs:
  export:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright python-dotenv pandas requests
          playwright install chromium
          playwright install-deps
      
      - name: Run Kalibrr Export
        env:
          KAID: ${{ secrets.KAID }}
          KB: ${{ secrets.KB }}
          GSHEET_URL: ${{ secrets.GSHEET_URL }}
          GSHEET_CSV_URL: ${{ secrets.GSHEET_CSV_URL }}
          FORCE_EXPORT: "true"
        run: |
          python kalibrr_export.py
      
      - name: Update CV links in existing results
        run: |
          python update_cv_links.py
      
      - name: Commit updated files to GitHub
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add sheet_positions.csv results*.csv
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update sheet_positions.csv and CV links from Google Sheets"
            # Use merge strategy instead of rebase to handle concurrent updates
            git pull --no-rebase origin ${{ github.ref_name }} || {
              echo "Merge conflict detected, resolving automatically..."
              # For CSV files, prefer our version (the latest data from the export)
              git checkout --ours sheet_positions.csv results*.csv 2>/dev/null || true
              git add sheet_positions.csv results*.csv
              # Complete the merge
              git -c core.editor=true merge --continue || {
                echo "Auto-merge failed, aborting merge"
                git merge --abort
                exit 1
              }
            }
            git push
          fi
      
      - name: Upload exported CSVs as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kalibrr-exports-${{ github.run_number }}
          path: kalibrr_exports/
          retention-days: 30
