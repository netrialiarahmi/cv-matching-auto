name: Automated CV Screening

on:
  workflow_run:
    workflows:
      - Dashboard Export and CV Link Update
    types:
      - completed
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write

jobs:
  screen:
    if: |
      github.event_name != 'workflow_run' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the exact commit produced by the export workflow
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pandas PyMuPDF requests openai python-dotenv
      
      - name: Run Automated CV Screening
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_BRANCH: ${{ env.TARGET_BRANCH }}
        run: |
          python scripts/auto_screen.py
      
      - name: Commit screening results to GitHub
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add results/*.csv
          git add logs/*.json 2>/dev/null || true
          if git diff --staged --quiet; then
            echo "No new candidates screened"
          else
            git commit -m "ðŸ¤– Automated CV screening results - $(date +'%Y-%m-%d %H:%M UTC')"
            # Pull latest changes with merge strategy
            git pull --no-rebase origin ${{ env.TARGET_BRANCH }} || {
              echo "Merge conflict detected, resolving automatically..."
              # For CSV result files, prefer our version (the latest screening data)
              find results -maxdepth 1 -name 'results*.csv' -type f -exec git checkout --ours {} \; 2>/dev/null || true
              find results -maxdepth 1 -name 'results*.csv' -type f -exec git add {} \;
              # Complete the merge
              git -c core.editor=: merge --continue || {
                echo "Auto-merge failed, aborting merge"
                git merge --abort
                exit 1
              }
            }
            git push
          fi
      
      - name: Upload screening logs as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screening-logs-${{ github.run_number }}
          path: |
            *.log
          retention-days: 7
          if-no-files-found: ignore
